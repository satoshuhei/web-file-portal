# 要件定義書

## 1. 概要
- 本システムは、SMBを使わずに既存の共有フォルダを読み取り専用で参照・検索・ダウンロードできるWebポータルである。
- ローカルファイルシステムを対象とし、ファイルメタデータはDBに同期して参照する。

## 2. 目的
- 共有フォルダの閲覧体験をWebで提供し、導入負荷を最小化する。
- 読み取り専用運用により、誤更新を防止する。

## 3. 対象範囲
### 3.1 対象
- ファイル/フォルダの閲覧、検索、プレビュー、ダウンロード
- DBインデックス同期バッチ
- ヘルスチェック

### 3.2 対象外
- 書き込み/更新/削除
- 認証/認可の実装 (現状はプレースホルダ)
- リアルタイム監視 (バッチ同期のみ)
- S3等の外部ストレージ統合 (将来拡張)

## 4. ステークホルダ
- 利用者: 共有フォルダの参照・検索を行うユーザ
- 運用者: バッチ同期や環境設定を行う管理者
- 開発/保守者: Djangoアプリの保守を行う担当

## 5. 用語
- テナント: データ分離の単位。現状は1テナント運用を想定。
- 共有フォルダ: APP_LOCAL_STORAGE_ROOT 配下のディレクトリ。
- インデックス同期: ファイルシステムの内容をDBに反映する処理。

## 6. 機能要件
### 6.1 参照
- フォルダ階層をパンくずで表示し、クリックで移動できること。
- ファイル一覧に名称、種類、更新日、サイズ、状態を表示できること。

### 6.2 検索
- ファイル名の部分一致検索ができること。
- フォルダ名の部分一致検索ができること。
- 正規表現検索ができること (対象はファイル名)。
- 1行1件の一括検索ができること。
- 更新日(From/To)で絞り込みできること。
- 拡張子の自由入力/チェック選択で絞り込みできること。

### 6.3 プレビュー
- PDFはブラウザで表示できること。
- テキスト系ファイルは最大200KBまでプレビューできること。
- 存在しないパスの要求は404で返すこと。

### 6.4 ダウンロード
- 単一ファイルをダウンロードできること。
- フォルダはZIP化してダウンロードできること。
- 検索結果をZIP化してダウンロードできること。
- 選択した複数ファイルをZIP化してダウンロードできること。

### 6.5 バッチ同期
- 共有フォルダの内容をDBに同期すること。
- 既存エントリとの作成/更新/削除を判定すること。
- 処理結果(件数/ステータス)をログとして保存すること。

### 6.6 ヘルスチェック
- /healthz にアクセスすると簡易な正常応答が返ること。

## 7. 非機能要件
### 7.0 優先度 (MoSCoW)
| 区分 | 内容 | 優先度 |
| --- | --- | --- |
| セキュリティ | 読み取り専用運用 | Must |
| セキュリティ | パストラバーサル防止 | Must |
| 性能 | 一覧/検索はDBインデックスを使用 | Must |
| 性能 | 一括ZIPはストリーミング返却 | Should |
| 可用性/運用 | バッチ同期の定期実行 | Should |
| 可用性/運用 | 失敗時の処理ログ記録 | Must |
| 監査 | 監査ログの保存領域を用意 | Could |

### 7.1 セキュリティ
- 読み取り専用運用を前提とする。
- パストラバーサルを防止する。

### 7.2 性能
- 一覧/検索はDBインデックスを使用し、ファイルシステム全走査は行わない。
- 一括ZIPはストリーミングレスポンスで返却する。

### 7.3 可用性/運用
- バッチ同期は定期実行を想定する。
- 失敗時は処理ログに記録する。

### 7.4 監査
- 監査ログの保存領域を用意する (現状はモデルのみ)。

## 8. 外部インタフェース
### 8.1 HTTP
- GET / : トップ
- GET /files/ : ファイル一覧/検索
- GET /files/preview : プレビュー
- GET /files/download : 単体ダウンロード
- GET /files/download-bulk : 検索結果のZIP
- POST /files/download-selected : 選択ZIP
- GET /healthz : ヘルスチェック

### 8.2 CLI
- python manage.py sync_file_index : インデックス同期
- python manage.py seed_sample_data : サンプル投入

## 9. 制約
- Django 6系
- DBはSQLite(デフォルト構成)
- ストレージはローカルファイルシステム

## 10. 受け入れ基準
- 要件6.1〜6.6が動作すること。
- /healthz が200で応答すること。
- 同期バッチが作成/更新/削除件数を正しく記録すること。

## 11. 関連図
- ユースケース図: [docs/uml/usecase.puml](docs/uml/usecase.puml)
- ユースケース図(画像): [docs/uml/images/usecase.png](docs/uml/images/usecase.png)
- コンポーネント図: [docs/uml/component.puml](docs/uml/component.puml)
- コンポーネント図(画像): [docs/uml/images/component.png](docs/uml/images/component.png)
- 配置図: [docs/uml/deployment.puml](docs/uml/deployment.puml)
- 配置図(画像): [docs/uml/images/deployment.png](docs/uml/images/deployment.png)
